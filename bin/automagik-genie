#!/usr/bin/env node

const { validateClaude } = require('../lib/claude-cli-check.js');
const { init } = require('../lib/init-unified.js');
const path = require('path');
const { spawn } = require('child_process');
const readline = require('readline');

// Constants - single source of truth for all repeated values
const CONSTANTS = {
  WISH_TEXT: '/wish analyze this codebase, understand patterns, and propose development agents to be created',
  EXIT_CODE: {
    SUCCESS: 0,
    ERROR: 1
  },
  MESSAGES: {
    GENIE_TITLE: 'üßû Automagik Genie - Universal AI Development Companion',
    INIT_START: 'üßû Initializing Automagik Genie...',
    INIT_SUCCESS: '‚ú® Genie successfully initialized!',
    ANALYSIS_START: 'üßû Starting intelligent codebase analysis...',
    ANALYSIS_COMPLETE: '‚ú® Analysis complete!',
    MANUAL_AVAILABLE: 'üí° Manual analysis available - run when ready:',
    AUTO_START_FAILED: '‚ö†Ô∏è  Could not auto-start analysis:',
    UNKNOWN_COMMAND: '‚ùå Unknown command:',
    INIT_FAILED: '‚ùå Initialization failed:',
    UNEXPECTED_ERROR: '‚ùå Unexpected error:',
    FATAL_ERROR: '‚ùå Fatal error:',
    HELP_SUGGESTION: 'üí° Run: npx automagik-genie --help',
    TROUBLESHOOTING: 'üîß Troubleshooting:',
    HAPPY_CODING: 'Happy coding! üßû‚ú®'
  }
};

// Utility functions
const logSpacing = () => console.log('');
const logWithSpacing = (message) => {
  logSpacing();
  console.log(message);
  logSpacing();
};
const exitWithError = (message) => {
  console.error(message);
  process.exit(CONSTANTS.EXIT_CODE.ERROR);
};

const showHelp = () => {
  console.log(CONSTANTS.MESSAGES.GENIE_TITLE);
  logSpacing();
  console.log('Usage:');
  console.log('  npx automagik-genie init            Initialize Genie (smart merge - preserves existing content)');
  console.log('  npx automagik-genie init --legacy   Use legacy mode (destructive replacement)');
  console.log('  npx automagik-genie update          Update agents and hooks to latest version');
  console.log('  npx automagik-genie rollback        Rollback to a previous backup');
  console.log('  npx automagik-genie status          Show system status and available updates');
  console.log('  npx automagik-genie cleanup         Clean up old backups and cache');
  console.log('  npx automagik-genie --help          Show this help message');
  logSpacing();
  console.log('Requirements:');
  console.log('  - Claude CLI must be installed and authenticated');
  console.log('  - Run in any project directory (any programming language)');
  logSpacing();
  console.log('What it does:');
  console.log('  ‚ú® Analyzes your codebase (any language: Go, Rust, Python, JS, etc.)');
  console.log('  ü§ñ Creates project-specific AI agents');
  console.log('  üéØ Provides /wish command for development assistance');
  console.log('  üîß Installs optional development workflow hooks');
  console.log('  üõ°Ô∏è  PRESERVES your custom agents, hooks, and configurations');
  console.log('  üîÑ Smart merge - no data loss, only updates what needs updating');
  logSpacing();
  console.log('After initialization:');
  console.log('  /wish "analyze this codebase"');
  console.log('  /wish "add authentication system"');
  console.log('  /wish "fix failing tests"');
  logSpacing();
  console.log('Update examples:');
  console.log('  npx automagik-genie update --dry-run    Preview updates');
  console.log('  npx automagik-genie update --agents-only Update only agents');
  console.log('  npx automagik-genie status --check-remote Check for updates');
  logSpacing();
  console.log('Smart merge vs Legacy:');
  console.log('  üõ°Ô∏è  Smart merge (default): Preserves ALL your custom content');
  console.log('  ‚ö†Ô∏è  Legacy mode: Destructive - backs up and replaces everything');
  logSpacing();
  console.log('Learn more: https://github.com/namastexlabs/automagik-genie');
};

const showPostInitInstructions = () => {
  console.log('üîç The analyzer agent will auto-detect your tech stack');
  logSpacing();
  console.log('üéØ Available commands:');
  console.log('   /wish "add feature X"     - Request new functionality');  
  console.log('   /wish "fix failing tests" - Debug and repair issues');
  console.log('   /wish "optimize performance" - Improve code efficiency');
  logSpacing();
  console.log('üìö Check .claude/hooks/examples/ for optional workflow automation');
  logSpacing();
  console.log(CONSTANTS.MESSAGES.HAPPY_CODING);
};

/**
 * Build Claude command with conditional permissions and wish text
 * @param {boolean} skipPermissions - Whether to add --dangerously-skip-permissions flag
 * @param {string} wishText - The wish command text to execute
 * @returns {string} Complete Claude command string
 */
const buildClaudeCommand = (skipPermissions, wishText) => {
  let command = 'claude';
  
  if (skipPermissions) {
    command += ' --dangerously-skip-permissions';
  }
  
  command += ` "${wishText}"`;
  return command;
};

/**
 * Show manual Claude command instructions with consistent formatting
 * @param {boolean} skipPermissions - Whether instructions should include skip permissions flag
 * @param {string} context - Context for the instructions (e.g., 'error', 'completion')
 */
const showManualInstructions = (skipPermissions, context = 'default') => {
  const command = buildClaudeCommand(skipPermissions, CONSTANTS.WISH_TEXT);
  
  console.log(CONSTANTS.MESSAGES.MANUAL_AVAILABLE);
  console.log(`   ${command}`);
};

/**
 * Handle Claude process errors with consistent messaging
 * @param {Error} error - The error object from Claude process
 * @param {boolean} skipPermissions - Whether skip permissions was used
 */
const handleClaudeError = (error, skipPermissions) => {
  logSpacing();
  console.log(CONSTANTS.MESSAGES.AUTO_START_FAILED);
  
  if (error.code === 'ENOENT') {
    console.log('   Claude CLI not found in PATH');
    console.log('   Please ensure Claude CLI is installed and authenticated');
  } else {
    console.log(`   ${error.message}`);
  }
  logSpacing();
  showManualInstructions(skipPermissions, 'error');
  logSpacing();
  showPostInitInstructions();
};

/**
 * Handle Claude process completion with consistent messaging
 * @param {number} code - Exit code from Claude process
 * @param {boolean} skipPermissions - Whether skip permissions was used
 */
const showAnalysisCompletion = (code, skipPermissions) => {
  logSpacing();
  
  if (code === CONSTANTS.EXIT_CODE.SUCCESS) {
    console.log(CONSTANTS.MESSAGES.ANALYSIS_COMPLETE);
  } else {
    showManualInstructions(skipPermissions, 'completion');
  }
  logSpacing();
  showPostInitInstructions();
};

/**
 * Prompt user for permission skip option
 * @returns {Promise<boolean>} True if user wants to skip permissions
 */
const promptForPermissionSkip = () => {
  return new Promise((resolve) => {
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });

    console.log('üîê Claude CLI Permission Options:');
    logSpacing();
    console.log('Claude CLI can run with enhanced permissions for full functionality,');
    console.log('or with restricted permissions for security-conscious environments.');
    logSpacing();
    
    rl.question('Do you want to start with "--dangerously-skip-permissions"? (y/n): ', (answer) => {
      rl.close();
      const skipPermissions = answer.toLowerCase() === 'y' || answer.toLowerCase() === 'yes';
      
      if (skipPermissions) {
        console.log('‚úÖ Will start Claude with --dangerously-skip-permissions');
      } else {
        console.log('‚úÖ Will start Claude with full permissions');
      }
      logSpacing();
      
      resolve(skipPermissions);
    });
  });
};

const main = async () => {
  const args = process.argv.slice(2);
  
  // Handle help command
  if (args.includes('--help') || args.includes('-h')) {
    showHelp();
    return;
  }
  
  // Handle version command
  if (args.includes('--version') || args.includes('-v')) {
    const packageJson = require('../package.json');
    console.log(packageJson.version);
    return;
  }
  
  // Extract command
  const command = args[0] || 'init';
  
  // Handle update-related commands by delegating to update CLI
  if (['update', 'rollback', 'status', 'cleanup'].includes(command)) {
    const { spawn } = require('child_process');
    const updateScript = path.join(__dirname, 'update.js');
    
    // Pass all arguments to the update script
    const updateProcess = spawn('node', [updateScript, ...args], {
      stdio: 'inherit',
      cwd: process.cwd()
    });

    updateProcess.on('close', (code) => {
      process.exit(code);
    });

    updateProcess.on('error', (error) => {
      console.error(CONSTANTS.MESSAGES.UNEXPECTED_ERROR, error.message);
      process.exit(CONSTANTS.EXIT_CODE.ERROR);
    });

    return;
  }
  
  // Handle init command
  if (command !== 'init') {
    console.log(CONSTANTS.MESSAGES.UNKNOWN_COMMAND, command);
    console.log(CONSTANTS.MESSAGES.HELP_SUGGESTION);
    process.exit(CONSTANTS.EXIT_CODE.ERROR);
  }
  
  console.log(CONSTANTS.MESSAGES.INIT_START);
  logSpacing();
  
  // Check Claude CLI first
  const claudeAvailable = await validateClaude();
  if (!claudeAvailable) {
    process.exit(CONSTANTS.EXIT_CODE.ERROR);
  }
  
  const targetPath = process.cwd();
  
  // Check for legacy flag
  const useLegacyMode = args.includes('--legacy');
  
  try {
    if (useLegacyMode) {
      console.log('‚ö†Ô∏è  Using legacy mode (destructive replacement)');
      logSpacing();
      await init(targetPath, { mode: 'legacy' });
    } else {
      console.log('üõ°Ô∏è  Using smart merge mode (preserves your content)');
      logSpacing();
      await init(targetPath, { mode: 'smart' });
    }
    
    logWithSpacing(CONSTANTS.MESSAGES.INIT_SUCCESS);
    
    // Prompt for permission skip option
    const skipPermissions = await promptForPermissionSkip();
    
    console.log(CONSTANTS.MESSAGES.ANALYSIS_START);
    logSpacing();
    
    // Build claude command for immediate analysis
    const claudeCommand = buildClaudeCommand(skipPermissions, CONSTANTS.WISH_TEXT);
    
    // Auto-trigger claude command for immediate analysis
    const claudeProcess = spawn(claudeCommand, {
      stdio: 'inherit',
      shell: true,
      cwd: targetPath
    });

    claudeProcess.on('error', (error) => {
      handleClaudeError(error, skipPermissions);
    });

    claudeProcess.on('close', (code) => {
      showAnalysisCompletion(code, skipPermissions);
    });
    
  } catch (error) {
    console.error(CONSTANTS.MESSAGES.INIT_FAILED, error.message);
    logSpacing();
    console.log(CONSTANTS.MESSAGES.TROUBLESHOOTING);
    console.log('   ‚Ä¢ Ensure you have write permissions in this directory');
    console.log('   ‚Ä¢ Check that Claude CLI is properly authenticated');
    console.log('   ‚Ä¢ Try running: claude auth');
    logSpacing();
    process.exit(CONSTANTS.EXIT_CODE.ERROR);
  }
};

// Handle unhandled errors gracefully
process.on('unhandledRejection', (error) => {
  exitWithError(`${CONSTANTS.MESSAGES.UNEXPECTED_ERROR} ${error.message}`);
});

process.on('uncaughtException', (error) => {
  exitWithError(`${CONSTANTS.MESSAGES.FATAL_ERROR} ${error.message}`);
});

main();